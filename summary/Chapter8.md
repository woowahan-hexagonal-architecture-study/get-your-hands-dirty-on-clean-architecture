# 08. 경계 간 매핑하기

- 각 계층의 모델을 매핑
- DTO 사용 범위 전략이라고도 할 수 있음

# ‘매핑하지 않기’ 전략

- 포트 인터페이스가 도메인 모델을 입출력 모델로 사용하면(같은걸 쓰면) 두 계층 간 매핑이 필요 없음

![Untitled](/images/chapter8/Untitled.png)

- 웹 계층과 애플리케이션, 영속성 계층 모두 `Account` 클래스에 접근함
    - 웹 계층 : 웹 컨트롤러가 UseCase 호출하면서 Account를 인자로 가져감
- Account 도메인 모델 클래스가 특수한 요구사항을 다뤄야할 수 있음
    - 웹 계층 : JSON 직렬화 어노테이션이 필요할 수 있음
    - 영속성 계층 : ORM프레임워크를 쓴다면 DB 매칭을 위한 특정 어노테이션이 필요할 것
    - 각 계층별 커스텀 필드가 필요할 수 있음


>💡 **단일 책임 원칙**
>- 방금 꺼는 위반한 사례
>- 웹, 애플리케이션, 영속성 계층과 관련되어 변경될 일이 많음
>

- **모든 계층이 정확히 같은 구조의 같은 정보를 필요로한다면 좋은 전략이 될 수 있음**
- **매핑 전략은 언제 선택해도 바꿀 수 있음 (처음에 빠르게 이걸로 해두고 바꿔도 된다)**

# ‘양방향' 매핑 전략

- 각 계층이 전용 모델을 가진 매핑 전략

![Untitled](/images/chapter8/Untitled%201.png)

- 각 계층이 뭔가 변경해도 각자 갖고 있어서 계층에 영향은 없음
- 어댑터가 전용 모델을 가지고 있어서 해당 모델을 도메인 모델로, 도메인 모델을 해당 모델로 매핑할 책임이 있음
- 단일 책임의 원칙을 만족함

단점

- 너무 많은 보일러플레이트(반복적으로 비슷하게 찍어내는 코드)가 생김
    - 매핑 프레임워크를 써도 매핑 구현하는데 시간이 걸린다
- 도메인 모델이 계층 경계를 넘어서 통신하는데 사용되고 있음
    - 인커밍, 아웃고잉 포트는 도메인 객체를 입력 파라미터와 반환값으로 사용하고있음
- **간단한 CRUD로직에서 조차 굳이 이렇게 구현할 필요는 없음 (괜히 복잡해지기만 함..)**
- **각 유스케이스마다 적절한 전략이 필요함**

# ‘완전' 매핑 전략

- 모든 각 계층, 모든 연산이 모델을 가지고 있음

![Untitled](/images/chapter8/Untitled%202.png)

- 계층 경계를 넘어선 통신을 할 때는 도메인모델 말고 포트의 입력에 특화된 모델을 사용함
    - 위 그림에서는 SendMoneyCommand가 특화모델 (command, request 등으로 불림)
    - SendMoneyUseCase : 구현 / SendMoneyCommand : 인터페이스
- 웹 계층은 입력을 애플리케이션 계층의 커맨드 객체로 매핑할 책임이 있음
    - 한 계층을 여러 커멘드로 매핑하는게 웹 모델-도메인 모델 간의 매핑보다 더 많은 코드가 필요함
- 보통 이 전역 패턴은 추천하지 않음
    - 웹 계층과 애플리케이션 계층 사이에서 유스케이스 경계가 명확할 때 필요함
    - 애플리케이션 계층과 영속성 계층 사이에서는 매핑 오버헤드때문에 권장하지 않음
    - 연산의 입력 모델에 대해서만 이 매핑을 사용하고 도메인 객체를 그대로 출력모델로 사용하는 것도 좋음


>💡 모든 파트가 같을 수 없고, 매핑 전략은 여러 가지를 섞어 쓸 수 있도록 관리
>

# ‘단방향' 매핑 전략

- 모든 계층의 모델들이 같은 인터페이스 구현

![Untitled](/images/chapter8/Untitled%203.png)

- 동일 인터페이스 구현을 통해 도메인 모델의 상태를 캡슐화함
- 도메인 모델 자체는 서비스에 접근할 수 있기도하고, 바깥 계층으로 매핑 없이 전달 가능
- 바깥 계층에서 상태 인터페이스를 사용할 지 전용 모델로 할지 선택 가능

>💡 **팩토리** 
>- DDD(Domain-Driven Degin)에서 나온 용어
>- 어떤 특정 상태로부터 도메인 객체를 재구성할 책임을 가지고 있다
>

- 한 방향으로만 매핑해서 책임이 명확함
- 계층을 넘나들며 퍼져있기 때문에 다른 전략에 비해 개념적으로 어렵다
- **계층간의 모델이 비슷할 때 효과적**

# 언제 어떤 매핑 전략을 사용할 것인가?

⇒ 그때그때 다르다

- 같은 코드에 여러 패턴을 섞을 수 있음
- 시간이 흐른 이후에 해당 전략이 여전히 최선인지는 아무도 모른다
    - 빠르게 코드를 적용하기 위해 계층간 결합을 떼어내는 것도 가능
- 팀내 합의할 수 있는 가이드라인을 정해둬야함
- 가이드라인 예시
    - 변경 유스케이스
        - 웹-애플리케이션 : 완전 매핑
        - 애플리케이션 - 영속성 : 매핑하지 않기 or 양방향 매핑
    - 쿼리 유스케이스
        - 매핑하지 않기 or 양방향 매핑

# 유지보수 가능한 소프트웨어를 만드는 데 어떻게 도움이 될까?

- 인커밍 포트와 아웃고잉 포트는 서로 다른 계층과 어떻게 통신할지 정함
    - 매핑 수행 여부
    - 어떤 매핑 전략을 선택할 것인지
- 좁은 포트 - 유스케이스마다 다른 매핑 전략 사용 가능
- 만능열쇠는 없기 때문에 지속적인 커뮤니케이션이 필요하다

---

참고

[계층형 아키텍처에서의 매핑전략](https://intrepidgeeks.com/tutorial/dto-availability-and-mapping-strategy)